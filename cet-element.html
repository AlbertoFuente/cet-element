<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/polymer/polymer.html">
<polymer-element name="cet-element" attributes="notitle author">

  <template>

    <link rel="stylesheet" href="cet-element.css">

    <content id="tableContainer"></content>

  </template>

  <script>

    Polymer({
      author: 'Alberto de la Fuente',
      created: function() {
        this.cet = {
            // add header title
            header: true,
            title: "Table Title",
            // add options to header
            options: true,
            listOptions: {
                'graphs': true,
                'downloads': true,
                'column_data_sum': true
            },
            // tooltips
            tooltips: true,
            // download options
            downloadOptions: {
                'json': true,
                'xml': true,
                'sql': true,
                'txt': true,
                'csv': true,
                'xsl': true,
                'doc': true,
                'pdf': true
            },
            // search
            search: true,
            // limit rows and add pager
            limitRows: 3,
            // config type of data service
            dataOptions: {
                'localData': true, // mode 1
                'fireBase': false // mode 2
            },
            // localData url
            localDataUrl: 'localData/tableData.json',
            // fireBase url
            fireBaseUrl: '',
            // display table effects
            effects: true,
            // sort table
            sortable: true,
            // div container
            container: document.getElementById('tableContainer')
          }
      },
      ready: function() {
        if (this.cet) {
            this.createTable(this.cet);
        }
      },
      createTable: function(cet) {
        if (cet) {
            // Detect type of data service
            if (cet.dataOptions.localData) {
                if (cet.localDataUrl !== '') {
                    this.setServices('localData');
                } else {
                    alert(tokenErrorLocalUrl);
                }
            } else if (cet.dataOptions.fireBase) {
                if (cet.fireBaseUrl !== '') {
                    this.setServices('fireBase');
                } else {
                    alert(tokenErrorFirebaseUrl);
                }
            } 
        }
      },
      setServices: function(service) {
            switch (service) {
                case 'localData':
                    this.cet.mode = 1;
                    this.getLocalData(this.cet);
                    break;
                case 'fireBase':
                    this.cet.mode = 2;
                    this.getfireBaseData(this.cet);
                    break;
            }
      },
      getMethod: function(url) {
        return new Promise(function(resolve, reject) {
            var req = new XMLHttpRequest();
            req.open('GET', url);

            req.onload = function() {
                if (req.status === 200) {
                    resolve(req.response);
                } else {
                    reject(Error(req.statusText));
                }
            };
            req.onerror = function() {
                reject(Error(req.statusText));
            };
            req.send();
        });
      },
      getLocalData: function(cet) {
        if (cet !== undefined) {
            cet.tableData = {};
            if (localStorage.getItem("_tableData")) {
                cet.tableData = JSON.parse(localStorage.getItem("_tableData"));
                this.tableConstructor(cet);
            } else {
                getJsonData(cet.localDataUrl).then(function(response) {
                    cet.tableData = JSON.parse(response);
                    this.tableConstructor(cet);
                }, function(error) {
                    throw new Error("Problems to find the JSON file in this url: " + url);
                });
            }
        }
      },
      getFireBaseData: function(cet) {
        if (cet !== undefined) {
            cet.tableData = {};
            var myFirebaseRef = new Firebase(cet.fireBaseUrl);

            myFirebaseRef.on("value", function(response) {
                cet.tableData = response.val();
                this.tableConstructor(cet);
            }, function(errorObject) {
                throw new Error("The read failed: " + errorObject.code);
            });
        }
      },
      tableConstructor: function(cet) {
        if (cet.header) {
            var tableHeader = document.createElement('div');
            tableHeader.className = 'tableHeader';

            var tableHeaderTitle = document.createElement('label');
            tableHeaderTitle.className = 'tableHeaderTitle';
            tableHeaderTitle.innerHTML = cet.title;

            if (cet.search) {

                var searchDiv = document.createElement('div');
                //searchDiv.className = cet.table.assignClasses('searchDiv') + ' searchTable';

                var icon = document.createElement('i');
                //icon.className = cet.table.assignClasses('searchIcon');
                var searchInput = document.createElement('input');
                searchInput.className = 'validate';
                searchInput.type = 'text';
                //searchInput.id = 'icon_prefix';
                var inputLabel = document.createElement('label');
                //inputLabel.setAttribute('for', 'icon_prefix');

                searchDiv.appendChild(icon);
                searchDiv.appendChild(searchInput);
                searchDiv.appendChild(inputLabel);

                tableHeader.appendChild(searchDiv);

                searchInput.onchange = function() {
                    this.tableSearcher(searchInput.value, cet.tableData);
                }
            }

            if (cet.options) {
                var tableHeaderOptions = document.createElement('button');
                tableHeaderOptions.className = 'normalButton';
                tableHeader.appendChild(tableHeaderOptions);

                var optionsContainer = document.createElement('div');
                optionsContainer.className = 'optionsContainer';
                optionsContainer.id = 'optionsContainer';
                optionsContainer.style.display = 'none';

                if (typeof cet.listOptions === 'object') {
                    this.listTableOptions(cet, optionsContainer, tableHeader);
                }

                tableHeaderOptions.onclick = function() {

                    var elementPosition = tableHeaderOptions.getBoundingClientRect();

                    optionsContainer.style.top = (elementPosition.top + 38) + 'px';
                    optionsContainer.style.left = (elementPosition.left - 164) + 'px';

                    if (tableHeaderOptions.className === 'normalButton') {
                        tableHeaderOptions.className = 'clickedButton';
                        if (document.getElementById('optionsContainer')) {
                            optionsContainer.style.display = 'block';
                        } else {
                            document.body.appendChild(optionsContainer);
                            optionsContainer.style.display = 'block';
                        }
                    } else {
                        tableHeaderOptions.className = 'normalButton ' + cet.table.assignClasses('headerButton');
                        optionsContainer.style.display = 'none';
                    }
                };

                window.onresize = function() {
                    var elementPosition = tableHeaderOptions.getBoundingClientRect();

                    if (optionsContainer.style.display === 'block') {
                        optionsContainer.style.top = (elementPosition.top + 38) + 'px';
                        optionsContainer.style.left = (elementPosition.left - 164) + 'px';
                    }
                };
            }

            tableHeader.appendChild(tableHeaderTitle);
            cet.container.appendChild(tableHeader);
            cet.container.className = 'cet-table-cnt';
        }
      }
    });

  </script>

</polymer-element>
