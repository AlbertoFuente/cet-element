<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-toolbar/core-toolbar.html">

<polymer-element name="cet-element" attributes="notitle author">

  <template>

    <link rel="stylesheet" href="cet-element.css">

    <core-toolbar>
    <core-icon-button icon="menu" on-tap="{{menuAction}}"></core-icon-button>
    <div flex>{{titleHeader}}</div>
    </core-toolbar>

  </template>

  <script>

    Polymer('cet-element', {
      author: 'Alberto de la Fuente',
      created: function() {
        this.cet = {
            // add header title
            header: true,
            title: "Table Title",
            // add options to header
            options: true,
            listOptions: {
                'graphs': true,
                'downloads': true,
                'column_data_sum': true
            },
            // tooltips
            tooltips: true,
            // download options
            downloadOptions: {
                'json': true,
                'xml': true,
                'sql': true,
                'txt': true,
                'csv': true,
                'xsl': true,
                'doc': true,
                'pdf': true
            },
            // search
            search: true,
            // limit rows and add pager
            limitRows: 3,
            // config type of data service
            dataOptions: {
                'localData': true, // mode 1
                'fireBase': false // mode 2
            },
            // localData url
            localDataUrl: 'localData/tableData.json',
            // fireBase url
            fireBaseUrl: '',
            // display table effects
            effects: true,
            // sort table
            sortable: true
          }
      },
      ready: function() {
        if (this.cet) {
            this.createTable(this.cet);
        }
      },
      createTable: function(cet) {
        if (cet) {
            // Detect type of data service
            if (cet.dataOptions.localData) {
                if (cet.localDataUrl !== '') {
                    this.setServices('localData');
                } else {
                    alert(tokenErrorLocalUrl);
                }
            } else if (cet.dataOptions.fireBase) {
                if (cet.fireBaseUrl !== '') {
                    this.setServices('fireBase');
                } else {
                    alert(tokenErrorFirebaseUrl);
                }
            } 
        }
      },
      setServices: function(service) {
            switch (service) {
                case 'localData':
                    this.cet.mode = 1;
                    this.getLocalData(this.cet);
                    break;
                case 'fireBase':
                    this.cet.mode = 2;
                    this.getfireBaseData(this.cet);
                    break;
            }
      },
      getMethod: function(url) {
        return new Promise(function(resolve, reject) {
            var req = new XMLHttpRequest();
            req.open('GET', url);

            req.onload = function() {
                if (req.status === 200) {
                    resolve(req.response);
                } else {
                    reject(Error(req.statusText));
                }
            };
            req.onerror = function() {
                reject(Error(req.statusText));
            };
            req.send();
        });
      },
      getLocalData: function(cet) {
        if (cet !== undefined) {
            cet.tableData = {};
            if (localStorage.getItem("_tableData")) {
                cet.tableData = JSON.parse(localStorage.getItem("_tableData"));
                this.tableConstructor(cet);
            } else {
                getJsonData(cet.localDataUrl).then(function(response) {
                    cet.tableData = JSON.parse(response);
                    this.tableConstructor(cet);
                }, function(error) {
                    throw new Error("Problems to find the JSON file in this url: " + url);
                });
            }
        }
      },
      getFireBaseData: function(cet) {
        if (cet !== undefined) {
            cet.tableData = {};
            var myFirebaseRef = new Firebase(cet.fireBaseUrl);

            myFirebaseRef.on("value", function(response) {
                cet.tableData = response.val();
                this.tableConstructor(cet);
            }, function(errorObject) {
                throw new Error("The read failed: " + errorObject.code);
            });
        }
      },
      tableConstructor: function(cet) {
        if (cet.header) {
            if (cet.title !== '') {
                document.querySelector('cet-element').titleHeader = cet.title;
                console.log(document.querySelector('cet-element'));
            }
        } else {
            document.querySelector('cet-element').shadowRoot.querySelector('core-toolbar').remove();
        }
      }
    });

  </script>

</polymer-element>
