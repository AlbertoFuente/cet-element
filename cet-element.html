<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="bower_components/core-dropdown/core-dropdown.html">

<polymer-element name="cet-element" attributes="notitle author">

  <template>

    <link rel="stylesheet" href="cet-element.css">

    <core-toolbar id="tableHeader">
    <div flex>{{titleHeader}}</div>
    <core-icon-button icon="search" id="searchIcon"></core-icon-button>
    <core-icon-button icon="menu" id="menuOptions"></core-icon-button>
    <core-dropdown relatedTarget="{{$.menuOptions}}" class="open-below">
      <core-menu>
        <core-item>{{graphs}}</core-item>
        <core-item>{{downloads}}</core-item>
        <core-item>{{dataSum}}</core-item>
      </core-menu>
    </core-dropdown>
    </core-toolbar>

    <div id="tableContainer">
    <table id="cetTable">
        <thead id="cetThead">
            <tr>
                <th template repeat="{{thD, i in thData}}" class="th{{i}}">{{thD}}
                    <template if="{{tdSortable}}">
                        <core-icon-button icon="expand-more" class="sortIcon{{i+1}}" on-click="{{sortTable}}">
                        </core-icon-button>
                    </template>
                </th>
            </tr>
        </thead>
        <tbody id="cetTbody">
        <template repeat="{{trD, i in trData}}">
            <tr class="{{trKeys(i)}}">
                <td template repeat="{{td in trD | keys}}" class="{{td}}">{{trD[td].data}}</td>
            </tr>
        </template>
        </tbody>
    </table>
    </div>

  </template>

  <script>
  (function() {
    Polymer('cet-element', {
      author: 'Alberto de la Fuente',
      created: function() {
        this.cet = {
            // add header title
            header: true,
            title: "Table Title",
            // add options to header
            options: true,
            listOptions: {
                'graphs': true,
                'downloads': true,
                'column_data_sum': true
            },
            // options texts
            graphTitle: 'Config graph options',
            downloadsTitle: 'Config graph options',
            sumTitle: 'Config sum options',
            // tooltips
            tooltips: true,
            // download options
            downloadOptions: {
                'json': true,
                'xml': true,
                'sql': true,
                'txt': true,
                'csv': true,
                'xsl': true,
                'doc': true,
                'pdf': true
            },
            // search
            search: true,
            // limit rows and add pager
            limitRows: 3,
            // config type of data service
            dataOptions: {
                'localData': true, // mode 1
                'fireBase': false // mode 2
            },
            // localData url
            localDataUrl: 'localData/tableData.json',
            // fireBase url
            fireBaseUrl: '',
            // display table effects
            effects: true,
            // sort table
            sortable: true
          }
      },
      ready: function() {
        if (this.cet) {
            this.createTable(this.cet);
        }
      },
      createTable: function(cet) {
        if (cet) {
            // Detect type of data service
            if (cet.dataOptions.localData) {
                if (cet.localDataUrl !== '') {
                    this.setServices('localData');
                } else {
                    alert('You must add localDataUrl in config.js');
                }
            } else if (cet.dataOptions.fireBase) {
                if (cet.fireBaseUrl !== '') {
                    this.setServices('fireBase');
                } else {
                    alert('You must add fireBaseUrl in config.js');
                }
            } 
        }
      },
      setServices: function(service) {
            switch (service) {
                case 'localData':
                    this.cet.mode = 1;
                    this.getLocalData(this.cet);
                    break;
                case 'fireBase':
                    this.cet.mode = 2;
                    this.getfireBaseData(this.cet);
                    break;
            }
      },
      getMethod: function(url) {
        return new Promise(function(resolve, reject) {
            var req = new XMLHttpRequest();
            req.open('GET', url);

            req.onload = function() {
                if (req.status === 200) {
                    resolve(req.response);
                } else {
                    reject(Error(req.statusText));
                }
            };
            req.onerror = function() {
                reject(Error(req.statusText));
            };
            req.send();
        });
      },
      getLocalData: function(cet) {
        if (cet !== undefined) {
            cet.tableData = {};
            if (localStorage.getItem("_tableData")) {
                cet.tableData = JSON.parse(localStorage.getItem("_tableData"));
                this.tableConstructor(cet);
            } else {
                getJsonData(cet.localDataUrl).then(function(response) {
                    cet.tableData = JSON.parse(response);
                    this.tableConstructor(cet);
                }, function(error) {
                    throw new Error("Problems to find the JSON file in this url: " + url);
                });
            }
        }
      },
      setLocalData: function(cet) {
        // save it in localStorage
        if (window.localStorage) {
            localStorage.setItem('_tableData', JSON.stringify(cet.tableData));
        } else {
            throw new Error("Your browser don't support LocalStorage!");
        }
      },
      getFireBaseData: function(cet) {
        if (cet !== undefined) {
            cet.tableData = {};
            var myFirebaseRef = new Firebase(cet.fireBaseUrl);

            myFirebaseRef.on("value", function(response) {
                cet.tableData = response.val();
                this.tableConstructor(cet);
            }, function(errorObject) {
                throw new Error("The read failed: " + errorObject.code);
            });
        }
      },
      setFirebaseData: function(cet) {
        if (cet.fireBaseUrl !== '') {
            var fireUrl = new Firebase(cet.fireBaseUrl);

            fireUrl.set(cet.tableData);
        }
      },
      keys: function(element) {
        return Object.keys(element);
      },
      trKeys: function(element) {
        if (element !== undefined) {
            var num = 'tr' + (element + 1);
            return num;
        }
      },
      tdKeys: function(element) {
        if (element !== undefined) {
            var num = 'td' + (element + 1);
            return num;
        }
      }, 
      sortTable: function(ev, detail, sender) {
        var self = this,
            trs = this.$.cetTbody.querySelectorAll('tr'),
            tds = this.$.cetTbody.querySelectorAll('td'),
            senderClass = sender.className,
            num = senderClass.slice(-1),
            changeIconClass = function(iconClass) {
                var i = 0,
                    icons = self.$.cetThead.querySelectorAll('core-icon-button');
                for (i; i < icons.length; i++) {
                    icons[i].icon = iconClass;
                }
            },
            selectedTds = function() {
                var i = 0,
                    j = 0,
                    tdsArr = [],
                    list = [],
                    isNum = null,
                    numData = null;
                // Add isNumeric() function to String class inside his prototype 
                if (!String.prototype.isNumeric) {
                    String.prototype.isNumeric = function() {
                        return !isNaN(parseFloat(this));
                    }
                }
                for (i; i < tds.length; i++) {
                    if (tds[i].className.slice(-1) === num) {
                        tdsArr.push(tds[i].innerHTML);
                    }
                }
                // check if the column have numeric data or not
                isNum = tdsArr.map(function(col) {
                    return col.isNumeric();
                });
                isNum.map(function(res) {
                    (res) ? numData = res : numData = res;
                });
                if (numData) {
                    if (sender.icon === 'expand-more') {
                        tdsArr.sort(function(a,b) { return a - b; });
                    } else {
                        tdsArr.sort(function(a,b) { return b - a; });
                    }
                } else {
                    if (sender.icon === 'expand-more') {
                        tdsArr.sort();
                    } else {
                        tdsArr.reverse();
                    }
                }
                console.log(tdsArr);
            };

        if (sender.icon === 'expand-more') {
            changeIconClass('expand-less');
        } else {
            changeIconClass('expand-more');
        } 

        selectedTds();
      },
      tableConstructor: function(cet) {
        // table header
        if (cet.header) {
            // header title
            if (cet.title !== '') {
                document.querySelector('cet-element').titleHeader = cet.title;
            }
            // header menu options
            if (cet.options) {
                // header menu list options
                if (cet.listOptions) {
                    if (cet.listOptions.graphs) {
                        document.querySelector('cet-element').graphs = cet.graphTitle;
                    }
                    if (cet.listOptions.downloads) {
                        document.querySelector('cet-element').downloads = cet.downloadsTitle;
                    }
                    if (cet.listOptions.column_data_sum) {
                        document.querySelector('cet-element').dataSum = cet.sumTitle;
                    }
                }
            } else {
                this.$.trigger.remove();
            }
            // searcher
            if (!cet.search) {
                this.$.searchIcon.remove();
            }
        } else {
            this.$.tableHeader.remove();
        }
        this.tableBody = function(tableData) {
            // Construct the table
            if (tableData !== undefined) {
                var i = 0,
                    j = 0,
                    headData = [],
                    bodyData = [];
                // table head data
                for(i in tableData[0].head) {
                    headData.push(tableData[0].head[i]);
                }
                document.querySelector('cet-element').thData = headData;
                // tHead sortable
                if (cet.sortable) {
                    document.querySelector('cet-element').tdSortable = true;
                }
                // table body data
                for (j in tableData[0].body) {
                    bodyData.push(tableData[0].body[j]);
                }
                document.querySelector('cet-element').trData = bodyData;
            }
        } 
        this.tableBody(cet.tableData);
      }
    });
  }());
  </script>
</polymer-element>
